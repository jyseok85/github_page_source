<p>처음에 만들었던 .Net 프로젝트를 실행합니다.(디버깅으로 실행해도 상관없습니다)
<img src="Images/K-001.png" alt="Alt text" />
기존처럼 동일하게 WeatherForecast 를 실행합니다.</p>

<p>기존엔 콘솔창으로 확인했지만, 템포 및 그라파나를 설치했기 때문에 그라파나에서 확인을 합니다. 
http://localhost:3000/ 기본 아이디 비번 admin,admin</p>

<p>좌측하단 설정 -&gt; Configration 클릭</p>

<p><img src="Images/K-006.png" alt="Alt text" /></p>

<p>Tempo -&gt; Explore 클릭
<img src="Images/K-007.png" alt="Alt text" /></p>

<p>우측 상단 Run Query(파란색아이콘) 클릭
<img src="Images/K-005.png" alt="Alt text" /></p>

<p>방금 요청한 API에 대한 트레이스가 나옵니다.</p>

<p>템포와 그라파나를 거쳐오기 때문에 실시간 반영이 되지 않습니다.</p>

<p>검색된 Trace ID를 클릭하면 상세 정보를 볼수 있습니다. 그러나 별 의미없는 단순 호출정보라서 (뭐 어쩌라고??) 생각됩니다.</p>

<p><img src="Images/K-008.png" alt="Alt text" /></p>

<p>참고로 현재 구축한 Trace 시스템은 아래와 같은 구성으로 동작됩니다. 
<img src="Images/%EA%B5%AC%EC%84%B1%EB%8F%84.png" alt="Alt text" /></p>

<p>단순한 API가 아니라. 실제 운영되는 서버처럼 복잡한 로직을 갖도록 프로젝트를 수정하겠습니다.</p>

<p><img src="Images/%EC%84%9C%EB%B2%84API%EA%B5%AC%EC%84%B1%EB%8F%84.png" alt="Alt text" /></p>

<ul>
  <li>
    <p>외부 API는 비동기로 호출하며 나머지 내부 API는 전부 동기로 호출합니다.</p>
  </li>
  <li>
    <p>내부에서 한번더 내부 API를 호출하도록 하고</p>
  </li>
  <li>
    <p>마지막 API는 오래걸리는 작업처럼 Delay를 추가합니다.</p>
  </li>
  <li>
    <p>그리고 기존에 있었던 실제 WeatherForecast 로직을 그냥 둡니다.</p>
  </li>
</ul>

<p>새로운 빈 Controller를 생성하고, 아래의 코드를 붙여넣기 합니다.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">TempoSample2.Controllers</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"[controller]"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Child1Controller</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"Child1"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nf">Get</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="s">"child 1"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"[controller]"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Child2Controller</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"Child2"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">Get</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">using</span><span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">uriBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">UriBuilder</span><span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Scheme</span><span class="p">,</span> <span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">Host</span><span class="p">,</span> <span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">Port</span> <span class="p">??</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="s">"Child21"</span><span class="p">);</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">uriBuilder</span><span class="p">.</span><span class="n">Uri</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span>  <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="n">uriBuilder</span><span class="p">.</span><span class="n">Uri</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">uriBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">UriBuilder</span><span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Scheme</span><span class="p">,</span> <span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">Host</span><span class="p">,</span> <span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">Port</span> <span class="p">??</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="s">"Child22"</span><span class="p">);</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">uriBuilder</span><span class="p">.</span><span class="n">Uri</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="n">uriBuilder</span><span class="p">.</span><span class="n">Uri</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="s">"OK"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"[controller]"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Child21Controller</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>

        <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"Child21"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">Get</span><span class="p">()</span>
        <span class="p">{</span>  
            <span class="k">return</span> <span class="s">"child 21"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"[controller]"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Child22Controller</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>

        <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"Child22"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">Get</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="s">"child 22"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"[controller]"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Child3Controller</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>

        <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"Child3"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">Get</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
            <span class="k">return</span> <span class="s">"child 3"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>



    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"[controller]"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">OtherController</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"GetW"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">Get</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">using</span> <span class="nn">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="s">"http://webcode.me"</span><span class="p">);</span>

            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>WeatherForecast 의 Get 메서드를 아래와 같이 수정합니다.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"GetWeatherForecast"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">WeatherForecast</span><span class="p">&gt;&gt;</span> <span class="nf">Get</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">tasks</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">otherclient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">otehruriBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">UriBuilder</span><span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Scheme</span><span class="p">,</span> <span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">Host</span><span class="p">,</span> <span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">Port</span> <span class="p">??</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="s">"Other"</span><span class="p">);</span>
    <span class="n">tasks</span> <span class="p">=</span> <span class="n">otherclient</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="n">otehruriBuilder</span><span class="p">.</span><span class="n">Uri</span><span class="p">);</span>

    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">uriBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">UriBuilder</span><span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Scheme</span><span class="p">,</span> <span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">Host</span><span class="p">,</span> <span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">Port</span> <span class="p">??</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="s">"Child1"</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">uriBuilder</span><span class="p">.</span><span class="n">Uri</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">uriBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">UriBuilder</span><span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Scheme</span><span class="p">,</span> <span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">Host</span><span class="p">,</span> <span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">Port</span> <span class="p">??</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="s">"Child2"</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="n">uriBuilder</span><span class="p">.</span><span class="n">Uri</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">uriBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">UriBuilder</span><span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Scheme</span><span class="p">,</span> <span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">Host</span><span class="p">,</span> <span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">Port</span> <span class="p">??</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="s">"Child3"</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="n">uriBuilder</span><span class="p">.</span><span class="n">Uri</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="n">tasks</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">5</span><span class="p">).</span><span class="nf">Select</span><span class="p">(</span><span class="n">index</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">WeatherForecast</span>
    <span class="p">{</span>
        <span class="n">Date</span> <span class="p">=</span> <span class="n">DateOnly</span><span class="p">.</span><span class="nf">FromDateTime</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">AddDays</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span>
        <span class="n">TemperatureC</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">Shared</span><span class="p">.</span><span class="nf">Next</span><span class="p">(-</span><span class="m">20</span><span class="p">,</span> <span class="m">55</span><span class="p">),</span>
        <span class="n">Summary</span> <span class="p">=</span> <span class="n">Summaries</span><span class="p">[</span><span class="n">Random</span><span class="p">.</span><span class="n">Shared</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">Summaries</span><span class="p">.</span><span class="n">Length</span><span class="p">)]</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nf">ToArray</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>실행하면 Swagger UI에 새로 생긴 api가 추가되었을텐데. 기존처럼 Weatherforecast api를 호출합니다.</p>

<p>그라파나로 들어가서 마지막에 호출된 TraceID를 클릭하면 우리가 추가한 API가 연속적으로 호출되며 제대로된 Trace 화면을 볼 수 있습니다. 
<img src="Images/K-009.png" alt="Alt text" />
전체 호출에 1.11s가 걸렸으며</p>

<p>외부 Api는 499.23ms 가 걸렸지만 비동기로 호출되어서 전체 시간에 영향은 없고,</p>

<p>Child3 이 1초 대기를 두어서 1.01s</p>
